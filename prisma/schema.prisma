// Prisma Schema for FormsAlexia
// Compatible with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SiteType {
  GREENFIELD
  ROOFTOP  
  POSTEVIA
}

// Tabla de Sitios/Instalaciones (expandida con datos del Excel)
model Site {
  id                String   @id @default(uuid())
  codigoTowernex    String   @unique @map("codigo_towernex") @db.VarChar(20)  // CO-ATL0031
  codigoSitio       String?  @map("codigo_sitio") @db.VarChar(20)             // ATL0031
  codIeneCombinado  String?  @map("cod_iene_combinado") @db.VarChar(20)       // Código IENE
  name              String   @db.VarChar(255)
  siteType          SiteType @map("site_type")

  // Ubicación
  latitud           Decimal? @db.Decimal(10, 6)
  longitud          Decimal? @db.Decimal(10, 6)
  direccion         String?  @db.VarChar(500)
  regional          String?  @db.VarChar(100)

  // Información de gestión
  contratistaOM     String?  @map("contratista_om") @db.VarChar(255)   // Contratista O&M
  empresaAuditora   String?  @map("empresa_auditora") @db.VarChar(255)
  tecnicoEA         String?  @map("tecnico_ea") @db.VarChar(255)       // Técnico EA

  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  forms             Form[]
  inventoryEE       InventoryEE[]  // Elementos en Estructura
  inventoryEP       InventoryEP[]  // Equipos en Piso

  @@index([codigoTowernex])
  @@index([codigoSitio])
  @@index([siteType])
  @@index([isActive])
  @@map("sites")
}

// Inventario de Elementos en Estructura (EE) - Antenas, RRUs, MW
model InventoryEE {
  id                  String   @id @default(uuid())
  siteId              String   @map("site_id")
  idEE                Int      @map("id_ee")                          // Número secuencial en el sitio

  tipoSoporte         String?  @map("tipo_soporte") @db.VarChar(100)  // Torre, Mástil, etc.
  tipoEE              String   @map("tipo_ee") @db.VarChar(50)        // ANTENA, RRU, MW
  situacion           String   @default("En servicio") @db.VarChar(50) // En servicio, Fuera de servicio
  situacionRRU        String?  @map("situacion_rru") @db.VarChar(50)
  modelo              String?  @db.VarChar(255)
  fabricante          String?  @db.VarChar(255)
  tipoExposicionViento String? @map("tipo_exposicion_viento") @db.VarChar(10) // N/T

  // Ubicación en estructura
  aristaCaraMastil    String?  @map("arista_cara_mastil") @db.VarChar(50) // Arista1, Arista2, Cara1, etc.
  operadorPropietario String?  @map("operador_propietario") @db.VarChar(100) // TIGO, CLARO, etc.
  alturaAntena        Decimal? @map("altura_antena") @db.Decimal(8, 4) // Altura en metros

  // Dimensiones
  diametro            Decimal? @db.Decimal(8, 4)
  largo               Decimal? @db.Decimal(8, 4)
  ancho               Decimal? @db.Decimal(8, 4)
  fondo               Decimal? @db.Decimal(8, 4)

  azimut              Decimal? @db.Decimal(8, 2) // Orientación en grados
  epaM2               Decimal? @map("epa_m2") @db.Decimal(10, 6) // Área de exposición al viento
  usoCompartido       Boolean  @default(false) @map("uso_compartido")
  sistemaMovil        String?  @map("sistema_movil") @db.VarChar(50) // 4G, 5G, LTE, etc.

  observaciones       String?  @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  site                Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, idEE])
  @@index([siteId])
  @@index([tipoEE])
  @@map("inventory_ee")
}

// Inventario de Equipos en Piso (EP) - Cabinets, Generadores, etc.
model InventoryEP {
  id                  String   @id @default(uuid())
  siteId              String   @map("site_id")
  idEP                Int      @map("id_ep")                          // Número secuencial en el sitio

  tipoPiso            String?  @map("tipo_piso") @db.VarChar(100)     // GREENFIELD, SHELTER, ROOFTOP, etc.
  ubicacionEquipo     String?  @map("ubicacion_equipo") @db.VarChar(100) // Cabinet Indoor/Outdoor
  situacion           String   @default("En servicio") @db.VarChar(50) // En servicio, Fuera de servicio
  estadoPiso          String?  @map("estado_piso") @db.VarChar(50)    // BUENO, ACEPTABLE, MALO, ND
  modelo              String?  @db.VarChar(255)
  fabricante          String?  @db.VarChar(255)

  usoEP               String?  @map("uso_ep") @db.VarChar(100)        // RADIO, ENERGIA, etc.
  operadorPropietario String?  @map("operador_propietario") @db.VarChar(100)

  // Dimensiones
  ancho               Decimal? @db.Decimal(8, 4)
  profundidad         Decimal? @db.Decimal(8, 4)
  altura              Decimal? @db.Decimal(8, 4)
  superficieOcupada   Decimal? @map("superficie_ocupada") @db.Decimal(10, 4) // m²

  observaciones       String?  @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  site                Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, idEP])
  @@index([siteId])
  @@index([tipoPiso])
  @@index([situacion])
  @@map("inventory_ep")
}

model Form {
  id             String      @id @default(uuid())
  name           String      @db.VarChar(255)
  description    String?     @db.Text
  siteId         String?     @map("site_id")
  siteType       SiteType    @default(GREENFIELD)
  version        Int         @default(1)
  metadataSchema Json?       @map("metadata_schema") // Defines what metadata fields are required: {location: {type: "text", required: true}, siteType: {type: "select", options: [...]} }
  sections       Json?       // Defines which additional sections are required: {security: {required: true, label: "Seguridad"}, inventory: {required: true}, torque: {required: false}}
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  site        Site?        @relation(fields: [siteId], references: [id])
  steps       FormStep[]
  submissions Submission[]

  @@index([siteId])
  @@map("forms")
}

model FormStep {
  id         String     @id @default(uuid())
  formId     String     @map("form_id")
  stepNumber Int        @map("step_number")
  title      String     @db.VarChar(255)
  createdAt  DateTime   @default(now()) @map("created_at")

  form      Form       @relation(fields: [formId], references: [id], onDelete: Cascade)
  questions Question[]
  files     File[]

  @@map("form_steps")
}

model Question {
  id           String   @id @default(uuid())
  stepId       String   @map("step_id")
  questionText String   @map("question_text") @db.Text
  type         String   @db.VarChar(50) // 'text', 'multiple_choice', 'single_choice', 'number', 'date', 'time', 'file_upload'
  options      Json?    // JSON array for multiple choice options
  isRequired   Boolean  @default(false) @map("is_required")
  orderNumber  Int      @map("order_number")
  metadata     Json?    // Additional metadata: validation rules, units, placeholders, file types, etc. {unit: "ohms", maxValue: 5, fileTypes: ["image/*", "video/*"]}
  createdAt    DateTime @default(now()) @map("created_at")

  step    FormStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  answers Answer[]

  @@map("questions")
}

model Submission {
  id          String    @id @default(uuid())
  formId      String    @map("form_id")
  userId      String?   @map("user_id")
  metadata    Json?     // Form-specific metadata values: {location: "CO-BOG0001", siteType: "Greenfield", technicianName: "John Doe", ...}
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  syncStatus  String    @default("pending") @map("sync_status") // 'pending', 'syncing', 'synced', 'failed'
  syncedAt    DateTime? @map("synced_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  form    Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  user    User?    @relation("UserSubmissions", fields: [userId], references: [id])
  answers Answer[]
  files   File[]

  @@index([syncStatus])
  @@index([formId])
  @@index([userId])
  @@map("submissions")
}

model Answer {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  questionId   String   @map("question_id")
  answerValue  Json?    @map("answer_value") // JSON for multiple choice answers
  answerText   String?  @map("answer_text") @db.Text
  answerComment String? @map("answer_comment") @db.VarChar(1028)
  createdAt    DateTime @default(now()) @map("created_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answers")
}

model File {
  id           String    @id @default(uuid())
  submissionId String    @map("submission_id")
  stepId       String    @map("step_id")
  questionId   String?   @map("question_id") // Optional: link to specific question for file uploads
  localPath    String?   @map("local_path") @db.VarChar(512)
  remotePath   String?   @map("remote_path") @db.VarChar(512)
  fileName     String    @map("file_name") @db.VarChar(255)
  fileSize     Int       @map("file_size")
  mimeType     String    @map("mime_type") @db.VarChar(100)
  syncStatus   String    @default("pending") @map("sync_status") // 'pending', 'syncing', 'synced', 'failed'
  createdAt    DateTime  @default(now()) @map("created_at")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  step       FormStep   @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([syncStatus])
  @@index([submissionId])
  @@index([questionId])
  @@map("files")
}

// Authentication and Authorization Models

enum UserStatus {
  PENDING_APPROVAL
  ACTIVE
  INACTIVE
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique @db.VarChar(255)
  passwordHash  String       @map("password_hash") @db.VarChar(255)
  firstName     String       @map("first_name") @db.VarChar(100)
  lastName      String       @map("last_name") @db.VarChar(100)
  status        UserStatus   @default(PENDING_APPROVAL)
  roleId        String       @map("role_id")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  approvedAt    DateTime?    @map("approved_at")
  approvedBy    String?      @map("approved_by")
  lastLoginAt   DateTime?    @map("last_login_at")

  role          Role         @relation(fields: [roleId], references: [id])
  approver      User?        @relation("UserApprovals", fields: [approvedBy], references: [id])
  approvals     User[]       @relation("UserApprovals")
  submissions   Submission[] @relation("UserSubmissions")
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([status])
  @@index([roleId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(50)
  description String?  @db.Text
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   @db.VarChar(50)
  action      String   @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  roles       RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}
